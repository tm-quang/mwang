<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Công việc</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS gốc của bạn được giữ nguyên, tôi không hiển thị lại ở đây cho ngắn gọn */
        :root {
            --primary-color: #0056b3; --primary-hover: #4338ca; --danger-color: #ef4444; --danger-hover: #dc2626; --success-color: #22c55e; --warning-color: #f97316; --bg-main: #ffffff; --bg-content: #ffffff; --bg-sidebar-left: #111827; --bg-sidebar-right: #f3f4f6; --bg-modal-overlay: rgba(17, 24, 39, 0.6); --text-primary: #111827; --text-secondary: #6b7280; --text-on-dark: #e5e7eb; --text-on-dark-hover: #ffffff; --text-on-primary: #ffffff; --border-color: #e5e7eb; --divider-color-dark: #374151; --border-radius-sm: 0.25rem; --border-radius-md: 0.375rem; --border-radius-lg: 0.5rem; --border-radius-full: 9999px; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body { margin: 0; padding: 0; font-family: var(--font-family); background-color: var(--bg-main); color: var(--text-primary); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #main-header { background-color: #0056b3; color: white; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); flex-shrink: 0; z-index: 10; }
        #header-left span { cursor: pointer; display: flex; align-items: center; gap: 8px; }
        #current-page-title { font-size: 1.1rem; font-weight: 500; flex-grow: 1; text-align: center; }
        #header-right { display: flex; align-items: center; gap: 20px; }
        #user-controls { display: flex; align-items: center; gap: 12px; }
        .greeting-text { font-weight: 500; }
        .header-logout-btn { background-color: var(--success-color); color: var(--text-on-primary); border: none; padding: 6px 12px; border-radius: var(--border-radius-md); cursor: pointer; font-weight: 600; }
        #live-clock { text-align: right; }
        #main-content-area { display: flex; flex-grow: 1; overflow: hidden; }
        #left-sidebar-container { width: 300px; background-color: var(--bg-sidebar-left); color: var(--text-on-dark); padding: 5px; flex-shrink: 0; overflow-y: auto; transition: width 0.3s ease; }
        #left-sidebar-container.collapsed { width: 80px; }
        /* ... các CSS khác của bạn ... */
        #content-container { flex-grow: 1; padding: 5px; overflow-y: auto; }
        #loadingSpinner { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="main-header">
        <div id="header-left">
            <span id="btnGoHomeHeader"><i class="fas fa-home header-icon"></i> Trang Chủ</span>
        </div>
        <div id="current-page-title"></div>
        <div id="header-right">
            <div id="user-controls" class="header-item">
                <span class="greeting-text">Xin chào</span>
                <button id="logoutButton" class="header-logout-btn">Đăng xuất</button>
            </div>
            <div id="live-clock" class="header-item">
                <span id="clock-time"></span>
                <span id="clock-date"></span>
            </div>
        </div>
    </div>
    <div id="main-content-area">
        <div id="left-sidebar-container" class="collapsed">
            <div class="sidebar-content-wrapper"></div>
        </div>
        <div id="content-container">
            <div id="loadingSpinner"></div>
            <div id="functionContent"></div>
        </div>
        <div id="right-sidebar-container" class="collapsed">
            <div class="sidebar-content-wrapper"></div>
        </div>
    </div>

    <script>
    // =================================================================
    // PHẦN 1: CẤU HÌNH VÀ GLOBAL VARIABLES
    // =================================================================
    const functionContent = document.getElementById('functionContent');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const currentPageTitle = document.getElementById('current-page-title');
    const leftSidebarContainer = document.getElementById('left-sidebar-container');
    const greetingText = document.querySelector('.greeting-text');
    let currentUser = null; // Lưu thông tin người dùng hiện tại

    // Cấu hình menu giữ nguyên như file gốc của bạn
    const leftMenuData = [
         { title: 'ADMIN', items: [ { id: 'btnADMIN', text: 'QUẢN TRỊ HỆ THỐNG', icon: 'fa-solid fa-sliders', isDropdown: true, isAdmin: true, subItems: [ { id: 'btnDatabase', text: 'DATABASE', pageUrl: 'admin-database.html', pageTitle: 'QUẢN LÝ DỮ LIỆU', icon: 'fa-solid fa-database' }, { id: 'btnUserInfo', text: 'QUẢN LÝ USER', pageUrl: 'admin-thong-tin-thanh-vien.html', pageTitle: 'QUẢN LÝ THÀNH VIÊN', icon: 'fa-solid fa-users' } ] } ] },
         { title: '2025 - IT MTAY2', items: [ { id: 'btnWorkLeader', text: 'TRIỂN KHAI IT MTAY2', icon: 'fas fa-laptop-code', isDropdown: true, subItems: [ { id: 'btnDeployMTay2', text: 'TRIỂN KHAI MIỀN TÂY 2', pageUrl: 'cv-trien-khai-mtay2.html', pageTitle: 'TRIỂN KHAI MIỀN TÂY 2', icon: 'fas fa-map-marked-alt' }, { id: 'btnBHXToiUu', text: 'TỐI ƯU BHX 2025', pageUrl: 'tk-bhx-toi-uu.html', pageTitle: 'TÌM KIẾM TỐI ƯU BÁCH HÓA XANH', icon: 'fas fa-cogs' } ] }, { id: 'btnDailyWork', text: 'CÔNG VIỆC HÀNG NGÀY', icon: 'fas fa-calendar-alt', isDropdown: true, subItems: [ { id: 'btnMonitor', text: 'KIỂM TRA LỖI HỆ THỐNG', pageUrl: 'cv-monitor.html', pageTitle: 'KIỂM TRA LỖI HỆ THỐNG', icon: 'fas fa-eye' }, { id: 'btnTimSheet', text: 'TÌM SHEET CÔNG VIỆC', pageUrl: 'tim-sheet.html', pageTitle: 'TRA CỨU DỮ LIỆU TỪ GOOGLE SHEET', icon: 'fa-solid fa-folder-tree' } ] }, { id: 'btnBTKK', text: 'LỊCH BẢO TRÌ - KIỂM KÊ', pageUrl: 'cv-baotri-kiemke.html', pageTitle: 'LỊCH BẢO TRÌ - KIỂM KÊ', icon: 'fas fa-tools' }, { id: 'btnTimKiem', text: 'TÌM THÔNG TIN', icon: 'fas fa-search', isDropdown: true, subItems: [ { id: 'btnTimSieuThi', text: 'TÌM KIẾM SIÊU THỊ', pageUrl: 'tim-kiem-sieu-thi.html', pageTitle: 'TÌM KIẾM SIÊU THỊ', icon: 'fas fa-store-alt' }, { id: 'btnTimHangBK', text: 'TÌM HÀNG HÓA BACKUP', pageUrl: 'tim-kiem-hang-bk.html', pageTitle: 'TÌM HÀNG HÓA BACKUP', icon: 'fas fa-box-open' } ] } ] },
         { title: 'TÀI LIỆU & HƯỚNG DẪN', items: [ { id: 'btnDashboard', text: 'BẢNG ĐIỀU KHIỂN', pageUrl: 'tai-lieu-dashboard.html', pageTitle: 'BẢNG ĐIỀU KHIỂN CHÍNH', icon: 'fas fa-tachometer-alt' } ] }
    ];

    // =================================================================
    // PHẦN 2: XÁC THỰC VÀ KHỞI TẠO
    // =================================================================
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('userToken');
        if (!token) {
            window.location.href = '/login.html'; // Nếu không có token, quay về trang đăng nhập
            return;
        }

        // Giải mã token để lấy thông tin user (chỉ làm ở client để hiển thị, server sẽ xác thực lại)
        try {
            currentUser = parseJwt(token);
            initializeApp();
        } catch (e) {
            console.error("Token không hợp lệ:", e);
            handleLogout(); // Nếu token lỗi, đăng xuất
        }
    });

    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(jsonPayload);
    }

    function initializeApp() {
        // Hiển thị thông tin người dùng
        if (currentUser) {
            greetingText.textContent = `Xin chào, ${currentUser.fullName}`;
            if (currentUser.isAdmin) {
                greetingText.innerHTML += ` <i class="fas fa-user-shield" style="color: #ef4444;"></i>`;
            }
        }

        renderLeftMenu(); // Render menu sau khi có thông tin user
        updateClock();
        setInterval(updateClock, 1000);
        
        // Tải trang chủ mặc định
        loadPageContent('thong-bao.html', 'BẢNG TIN CÔNG VIỆC');

        // Gắn các sự kiện khác
        document.getElementById('logoutButton').addEventListener('click', handleLogout);
        document.getElementById('btnGoHomeHeader').addEventListener('click', () => loadPageContent('thong-bao.html', 'BẢNG TIN CÔNG VIỆC'));
        leftSidebarContainer.addEventListener('mouseenter', () => expandSidebar(leftSidebarContainer));
        leftSidebarContainer.addEventListener('mouseleave', () => collapseSidebar(leftSidebarContainer));
    }


    // =================================================================
    // PHẦN 3: CÁC HÀM XỬ LÝ GIAO DIỆN
    // =================================================================
    
    function renderLeftMenu() {
        const wrapper = leftSidebarContainer.querySelector('.sidebar-content-wrapper');
        wrapper.innerHTML = '';
        leftMenuData.forEach(section => {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'menu-section';
            sectionDiv.innerHTML = `<h3 class="menu-section-title"><span>${section.title}</span></h3>`;
            
            section.items.forEach(item => {
                // Chỉ hiển thị menu Admin nếu người dùng là admin
                if (item.isAdmin && (!currentUser || !currentUser.isAdmin)) {
                    return; 
                }
                
                if (item.isDropdown) {
                    const dropdownDiv = document.createElement('div');
                    // ... (logic tạo dropdown giữ nguyên, chỉ thay đổi hàm load content)
                     item.subItems.forEach(subItem => {
                        const subLink = document.createElement('a');
                        subLink.href = '#';
                        subLink.className = 'menu-button-sidebar';
                        subLink.innerHTML = `<i class="${subItem.icon} icon"></i><span>${subItem.text}</span>`;
                        subLink.onclick = (e) => {
                            e.preventDefault();
                            loadPageContent(subItem.pageUrl, subItem.pageTitle);
                            // ...
                        };
                        // ...
                    });
                } else {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = 'menu-button-sidebar';
                    a.innerHTML = `<i class="${item.icon} icon"></i><span>${item.text}</span>`;
                    a.onclick = (e) => {
                        e.preventDefault();
                        loadPageContent(item.pageUrl, item.pageTitle);
                        collapseSidebar(leftSidebarContainer);
                    };
                    sectionDiv.appendChild(a);
                }
            });
            wrapper.appendChild(sectionDiv);
        });
    }

    async function loadPageContent(pageUrl, pageTitle = '') {
        functionContent.innerHTML = '';
        loadingSpinner.style.display = 'block';
        currentPageTitle.textContent = pageTitle;

        try {
            const response = await fetch(`/${pageUrl}`);
            if (!response.ok) {
                throw new Error(`Không thể tải file: ${response.statusText}`);
            }
            const htmlString = await response.text();
            
            loadingSpinner.style.display = 'none';
            functionContent.innerHTML = htmlString;
            
            // Re-execute scripts in the loaded content
            Array.from(functionContent.querySelectorAll('script')).forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });

        } catch (error) {
            loadingSpinner.style.display = 'none';
            functionContent.innerHTML = `<p style="color: red; text-align: center;">Lỗi tải nội dung: ${error.message}</p>`;
            console.error("Lỗi fetch trang:", error);
        }
    }

    function handleLogout() {
        localStorage.removeItem('userToken');
        window.location.href = '/login.html';
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('clock-time').textContent = now.toLocaleTimeString('vi-VN');
        document.getElementById('clock-date').textContent = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long' });
    }
    
    function collapseSidebar(sidebar) { sidebar.classList.add('collapsed'); }
    function expandSidebar(sidebar) { sidebar.classList.remove('collapsed'); }

</script>
</body>
</html>