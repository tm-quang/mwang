<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập | Quản lý Công việc</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="login-page-body">
    <div class="main-container">
        <div class="info-panel">
            <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
                <defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" /></defs>
                <g class="parallax">
                    <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(255,255,255,0.7)" />
                    <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(255,255,255,0.5)" />
                    <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(255,255,255,0.3)" />
                    <use xlink:href="#gentle-wave" x="48" y="7" fill="#fff" />
                </g>
            </svg>
            <div class="info-panel-logo">
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-The-Gioi-Di-Dong-MWG.png" alt="Logo">
            </div>
            <h2>Chào mừng bạn!</h2>
            <p>Đăng nhập để tiếp tục truy cập vào hệ thống và quản lý công việc của bạn một cách hiệu quả nhất.</p>
        </div>
        <div class="form-panel">
            <div class="form-wrapper">
                <div class="logo">
                    <i class="fa-solid fa-shield-halved"></i>
                </div>
                <div class="tab-buttons">
                    <button class="tab-button active" id="login-tab-button" onclick="showTab('login')">Đăng nhập</button>
                    <button class="tab-button" id="signup-tab-button" onclick="showTab('signup')">Đăng ký</button>
                </div>

                <div id="loginTab" class="tab-content active">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <input type="text" id="loginUsername" name="username" required placeholder="Tên đăng nhập">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="form-group">
                            <input type="password" id="loginPassword" name="password" required placeholder="Mật khẩu">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                        <div class="button-group">
                           <button type="submit" class="btn">Đăng nhập</button>
                           <button type="button" class="btn btn-clear" onclick="clearForm('loginForm')">Xóa</button>
                        </div>
                    </form>
                </div>

                <div id="signupTab" class="tab-content">
                    <form id="signupForm" onsubmit="handleSignup(event)">
                        <div class="form-group">
                            <input type="text" id="signupUsername" placeholder="Tên đăng nhập" name="username" required>
                            <i class="fa-solid fa-user-plus"></i>
                        </div>
                        <div class="form-group">
                            <input type="password" id="signupPassword" placeholder="Mật khẩu" name="password" required>
                            <i class="fa-solid fa-lock"></i>
                        </div>
                        <div class="form-group">
                            <input type="password" id="signupConfirmPassword" placeholder="Xác nhận mật khẩu" required>
                            <i class="fa-solid fa-key"></i>
                        </div>
                        <div class="form-group">
                            <input type="text" id="signupFullName" placeholder="Tên đầy đủ của bạn" name="fullName" required>
                            <i class="fa-solid fa-id-card"></i>
                        </div>
                        <div class="form-group">
                            <input type="tel" id="signupPhone" placeholder="Số điện thoại" name="phone" required>
                            <i class="fa-solid fa-phone"></i>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn">Đăng ký</button>
                            <button type="button" class="btn btn-clear" onclick="clearForm('signupForm')">Xóa</button>
                        </div>
                    </form>
                </div>
                
                <button type="button" class="btn btn-guest" onclick="handleGuestLogin()">Đăng nhập tài khoản khách</button>

            </div>
        </div>
    </div>
    
    <div id="errorAlert-login" class="alert-toast">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorAlertMessage-login"></span>
    </div>
    <div id="successAlert-login" class="alert-toast">
        <i class="fas fa-check-circle"></i>
        <span id="successAlertMessage-login"></span>
    </div>


    <div class="support-widget" id="supportWidget">
        <div class="support-info-box" id="supportInfoBox">
            <div class="support-header">
                <h4>Liên Hệ Hỗ Trợ:</h4>
                <button class="close-support-btn" id="closeSupportBox">×</button>
            </div>
            <div class="support-body">
                <p>112080 - Trần Minh Quang</p>
                <a href="mailto:minhquang030@gmail.com">minhquang030@gmail.com</a>
                <p style="margin-top: 10px;">Hotline:</p>
                <strong>0933960788</strong>
            </div>
        </div>
        <button class="support-bubble" id="supportBubble">
            <i class="fas fa-headset"></i>
        </button>
    </div>

    <div id="loadingIndicator-login"><div class="spinner"></div></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwYngixrO7jMyLyvYtTgAieHeppH3kL4brU3Oh4VfGYY3jY9bcBqsZo2dUhpxTRsybV0g/exec";

        document.addEventListener('DOMContentLoaded', () => {
            showTab('login');
            const supportWidget = document.getElementById('supportWidget');
            const supportBubble = document.getElementById('supportBubble');
            supportBubble.addEventListener('click', (event) => {
                event.stopPropagation(); 
                supportWidget.classList.toggle('open');
            });
            document.getElementById('closeSupportBox').addEventListener('click', () => {
                supportWidget.classList.remove('open');
            });
            window.addEventListener('click', () => {
                if (supportWidget.classList.contains('open')) {
                    supportWidget.classList.remove('open');
                }
            });
        });

        let errorAlertTimeout;
        function showErrorAlert(message) {
            const alertBox = document.getElementById('errorAlert-login');
            const msgSpan = document.getElementById('errorAlertMessage-login');
            if(msgSpan) msgSpan.textContent = message;
            alertBox.classList.add('show');
            clearTimeout(errorAlertTimeout);
            errorAlertTimeout = setTimeout(() => {
                alertBox.classList.remove('show');
            }, 4000);
        }

        let successAlertTimeout;
        function showSuccessAlert(message) {
            const alertBox = document.getElementById('successAlert-login');
            const msgSpan = document.getElementById('successAlertMessage-login');
            if(msgSpan) msgSpan.textContent = message;
            alertBox.classList.add('show');
            clearTimeout(successAlertTimeout);
            successAlertTimeout = setTimeout(() => {
                alertBox.classList.remove('show');
            }, 4000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.getElementById(tabName + '-tab-button').classList.add('active');
        }

        function showLoadingIndicator() { document.getElementById('loadingIndicator-login').style.display = 'flex'; }
        function hideLoadingIndicator() { document.getElementById('loadingIndicator-login').style.display = 'none'; }
        function clearForm(formId) {
            const form = document.getElementById(formId);
            if (form) form.reset();
        }

        async function callApiLogin(action, payload = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            url.searchParams.append('payload', JSON.stringify(payload));
            const response = await fetch(url, { redirect: 'follow' });
            if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
            return await response.json();
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            showLoadingIndicator();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await callApiLogin('handleLogin', { username, password });
                hideLoadingIndicator();
                if (response.success) {
                    sessionStorage.setItem('isAuthenticated', 'true');
                    sessionStorage.setItem('userName', response.fullName);
                    sessionStorage.setItem('userMode', 'user');
                    
                    showSuccessAlert('Đăng nhập thành công, đang chuyển trang...');
                    
                    setTimeout(() => {
                         window.location.href = 'trang-chu.html';
                    }, 2000);

                } else {
                    showErrorAlert(response.message);
                }
            } catch (error) {
                hideLoadingIndicator();
                showErrorAlert('Lỗi hệ thống: ' + error.message);
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showErrorAlert('Mật khẩu xác nhận không khớp!');
                return;
            }

            showLoadingIndicator();
            const username = document.getElementById('signupUsername').value;
            const fullName = document.getElementById('signupFullName').value;
            const phone = document.getElementById('signupPhone').value;
            
            try {
                const response = await callApiLogin('handleRegister', { username, password, fullName, phone });
                 hideLoadingIndicator();
                if (response.success) {
                    document.getElementById('signupForm').reset();
                    showSuccessAlert(response.message);
                    showTab('login');
                } else {
                    showErrorAlert(response.message);
                }
            } catch (error) {
                hideLoadingIndicator();
                showErrorAlert('Lỗi hệ thống: ' + error.message);
            }
        }

        function handleGuestLogin() {
            sessionStorage.setItem('isAuthenticated', 'true');
            sessionStorage.setItem('userName', 'Khách');
            sessionStorage.setItem('userMode', 'guest');
            window.location.href = 'trang-chu.html';
        }
    </script>
</body>
</html>